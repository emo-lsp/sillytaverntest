<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>苍玄大陆·山河图</title>
    <style>
        :root {
            --corner-radius: 16px;
            --spacing-xs: 6px;
            --spacing-s: 10px;
            --spacing-m: 14px;
            --spacing-l: 18px;
            --primary-gold: #c9a961;
            --primary-jade: #5a8a7e;
            --primary-red: #a73a3a;
            --primary-purple: #7a5a8a;
            --primary-blue: #4a7c9e;
            --primary-orange: #d4843a;
            --bg-primary: #faf8f5;
            --bg-secondary: #fff9f0;
            --bg-card: #ffffff;
            --text-primary: #3a3330;
            --text-secondary: #6a635a;
            --text-light: #8a8580;
            --border-color: #d4c4b0;
            --border-light: #e8ddd4;
            --shadow-light: rgba(58, 51, 48, 0.08);
            --shadow-medium: rgba(58, 51, 48, 0.12);
            --shadow-strong: rgba(58, 51, 48, 0.18);
            --glass-panel: rgba(255, 255, 255, 0.58);
            --glass-panel-strong: rgba(255, 255, 255, 0.72);
            --glass-panel-soft: rgba(255, 249, 240, 0.42);
            --glass-border: rgba(255, 255, 255, 0.55);
            --glass-shine: rgba(255, 255, 255, 0.28);
            --tint-gold-soft: rgba(201, 169, 97, 0.16);
            --tint-jade-soft: rgba(90, 138, 126, 0.14);
            --toast-bg: rgba(34, 30, 27, 0.82);
            --toast-text: #f8f1e6;
            --toast-border: rgba(255, 255, 255, 0.28);
            --toast-text-shadow: 0 1px 1px rgba(0, 0, 0, 0.22);
            --transition-smooth: cubic-bezier(0.4, 0, 0.2, 1);
            --transition-bounce: cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        [data-theme="dark"] {
            --primary-gold: #d4af37;
            --primary-jade: #6fa393;
            --primary-red: #c85450;
            --primary-purple: #9a7ab0;
            --primary-blue: #5a9cc8;
            --primary-orange: #e89c4a;
            --bg-primary: #1a1815;
            --bg-secondary: #252320;
            --bg-card: #2a2825;
            --text-primary: #f0e8e0;
            --text-secondary: #b8b0a8;
            --text-light: #8a8278;
            --border-color: #4a453f;
            --border-light: #3a3530;
            --shadow-light: rgba(0, 0, 0, 0.2);
            --shadow-medium: rgba(0, 0, 0, 0.3);
            --shadow-strong: rgba(0, 0, 0, 0.4);
            --glass-panel: rgba(42, 40, 37, 0.62);
            --glass-panel-strong: rgba(52, 49, 46, 0.74);
            --glass-panel-soft: rgba(37, 35, 32, 0.44);
            --glass-border: rgba(110, 102, 92, 0.45);
            --glass-shine: rgba(255, 255, 255, 0.1);
            --tint-gold-soft: rgba(212, 175, 55, 0.12);
            --tint-jade-soft: rgba(111, 163, 147, 0.14);
            --toast-bg: rgba(246, 238, 226, 0.88);
            --toast-text: #2a241f;
            --toast-border: rgba(58, 51, 48, 0.24);
            --toast-text-shadow: 0 0 0 transparent;
        }

        html {
            font-size: 16px;
            -webkit-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: "STSong", "SimSun", "宋体", -apple-system, BlinkMacSystemFont, serif;
            background: transparent;
            color: var(--text-primary);
            padding: var(--spacing-m);
            line-height: 1.4;
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            font-smooth: always;
        }

        .map-status-bar {
            max-width: 720px;
            margin: 0 auto;
            background: var(--glass-panel);
            border-radius: var(--corner-radius);
            border: 1px solid var(--glass-border);
            box-shadow: 0 12px 30px var(--shadow-medium);
            overflow: hidden;
            transition: all 0.3s var(--transition-smooth);
            contain: layout style paint;
            position: relative;
            isolation: isolate;
            backdrop-filter: blur(14px) saturate(130%);
            -webkit-backdrop-filter: blur(14px) saturate(130%);
        }

        .map-status-bar::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(160deg, var(--glass-shine) 0%, transparent 42%, var(--glass-shine) 100%);
            pointer-events: none;
            z-index: 0;
        }

        .map-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-m) var(--spacing-l);
            background: linear-gradient(135deg, var(--glass-panel-strong) 0%, var(--glass-panel-soft) 100%);
            border-bottom: 1px solid var(--border-light);
            cursor: pointer;
            user-select: none;
            transition: all 0.2s var(--transition-smooth);
            position: relative;
            z-index: 1;
        }

        .map-header:hover {
            background: linear-gradient(135deg, var(--glass-panel-soft) 0%, var(--glass-panel-strong) 100%);
        }

        .map-header-left {
            display: flex;
            align-items: center;
            gap: var(--spacing-s);
        }

        .map-icon {
            width: 24px;
            height: 24px;
            fill: var(--primary-gold);
            transition: transform 0.3s var(--transition-smooth);
        }

        .map-status-bar.collapsed .map-icon {
            transform: rotate(-90deg);
        }

        .map-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: 2px;
        }

        .map-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
            letter-spacing: 0.5px;
            margin-left: var(--spacing-s);
        }

        .map-controls {
            display: flex;
            gap: var(--spacing-xs);
            align-items: center;
        }

        .control-btn {
            width: 28px;
            height: 28px;
            background: var(--glass-panel-strong);
            border: 1px solid var(--border-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s var(--transition-smooth);
            backdrop-filter: blur(6px) saturate(120%);
            -webkit-backdrop-filter: blur(6px) saturate(120%);
        }

        .control-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--primary-gold);
            transform: scale(1.1);
        }

        .control-btn svg {
            width: 14px;
            height: 14px;
            fill: var(--text-secondary);
        }

        .map-content {
            height: 0;
            overflow: hidden;
            transition: height 0.3s var(--transition-smooth);
            background: var(--glass-panel-soft);
            position: relative;
            z-index: 1;
        }

        .map-status-bar.expanded .map-content {
            height: 450px;
        }

        .map-viewport {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, var(--glass-panel-soft) 0%, var(--glass-panel) 100%);
            touch-action: none;
            contain: strict;
        }

        .map-viewport::before {
            content: '';
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 0;
            background:
                radial-gradient(circle at 15% 20%, var(--tint-gold-soft) 0%, transparent 50%),
                radial-gradient(circle at 85% 75%, var(--tint-jade-soft) 0%, transparent 50%);
            opacity: 0.8;
        }

        .map-canvas {
            position: absolute;
            width: 1000px;
            height: 650px;
            top: 50%;
            left: 50%;
            transform: translate3d(-50%, -50%, 0) scale(1);
            cursor: grab;
            user-select: none;
            transform-origin: center center;
            z-index: 1;
            --inverse-scale: 1;
        }

        .map-canvas.dragging {
            cursor: grabbing;
        }

        .zoom-controls {
            position: absolute;
            right: 10px;
            bottom: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 100;
        }

        .zoom-btn {
            width: 36px;
            height: 36px;
            background: var(--glass-panel-strong);
            border: 1px solid var(--glass-border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s var(--transition-smooth);
            box-shadow: 0 4px 14px var(--shadow-light);
            backdrop-filter: blur(6px) saturate(120%);
            -webkit-backdrop-filter: blur(6px) saturate(120%);
        }

        .zoom-btn:hover {
            background: var(--bg-secondary);
            transform: scale(1.1);
        }

        .zoom-btn:active {
            transform: scale(0.95);
        }

        .zoom-btn svg {
            width: 18px;
            height: 18px;
            fill: var(--text-primary);
        }

        .continent-bg {
            position: absolute;
            border-radius: 50%;
            opacity: 0.08;
            pointer-events: none;
            animation: spiritDrift 10s ease-in-out infinite;
            filter: blur(1px);
        }

        .bg-east {
            width: 220px;
            height: 220px;
            background: radial-gradient(circle, var(--primary-jade) 0%, transparent 70%);
            left: 610px;
            top: 210px;
            animation-delay: -1.1s;
        }

        .bg-west {
            width: 220px;
            height: 220px;
            background: radial-gradient(circle, var(--primary-red) 0%, transparent 70%);
            left: 170px;
            top: 210px;
            animation-delay: -3.2s;
        }

        .bg-south {
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, var(--primary-orange) 0%, transparent 70%);
            left: 400px;
            top: 410px;
            animation-delay: -4.6s;
        }

        .bg-north {
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, var(--primary-blue) 0%, transparent 70%);
            left: 400px;
            top: 30px;
            animation-delay: -2.4s;
        }

        .bg-center {
            width: 240px;
            height: 240px;
            background: radial-gradient(circle, var(--primary-purple) 0%, transparent 70%);
            left: 380px;
            top: 205px;
            animation-delay: -5.3s;
        }

        .continent-label {
            position: absolute;
            font-size: 24px;
            font-weight: 600;
            letter-spacing: 4px;
            opacity: 0.2;
            pointer-events: none;
            color: var(--text-primary);
            z-index: 1;
            transform-origin: center center;
            transform: scale(var(--inverse-scale, 1));
            text-shadow: 0 2px 8px var(--shadow-light);
            text-rendering: geometricPrecision;
        }

        .label-east {
            left: 700px;
            top: 300px;
            color: var(--primary-jade);
        }

        .label-west {
            left: 260px;
            top: 300px;
            color: var(--primary-red);
        }

        .label-south {
            left: 480px;
            top: 500px;
            color: var(--primary-orange);
        }

        .label-north {
            left: 480px;
            top: 100px;
            color: var(--primary-blue);
        }

        .label-center {
            left: 470px;
            top: 310px;
            color: var(--primary-purple);
        }

        .location-group {
            position: absolute;
            pointer-events: none;
            z-index: 10;
        }

        .location-marker {
            position: absolute;
            cursor: pointer;
            pointer-events: all;
            transition: transform 0.2s var(--transition-smooth);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            will-change: transform;
            opacity: 0;
            transform: translateY(12px) scale(0.96);
        }

        .location-marker:hover {
            transform: translateY(-2px);
            z-index: 20;
        }

        .location-pin {
            --pin-hover-scale: 1;
            width: 20px;
            height: 20px;
            background: var(--glass-panel-strong);
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg) scale(calc(var(--inverse-scale, 1) * var(--pin-hover-scale)));
            transform-origin: center center;
            box-shadow: 0 2px 4px var(--shadow-medium);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            border: 1.5px solid currentColor;
            transition: all 0.2s var(--transition-smooth);
            will-change: transform;
        }

        .location-marker:hover .location-pin {
            box-shadow: 0 3px 8px var(--shadow-strong);
            --pin-hover-scale: 1.08;
        }

        .location-pin::before {
            content: '';
            width: 5px;
            height: 5px;
            background: currentColor;
            border-radius: 50%;
            transform: rotate(45deg);
        }

        .location-pin::after {
            content: '';
            position: absolute;
            inset: -5px;
            border-radius: 50%;
            border: 1px solid currentColor;
            opacity: 0;
        }

        .location-special .location-pin::after {
            opacity: 0.35;
            animation: markerPulse 3.1s ease-out infinite;
        }

        .location-name {
            --label-hover-scale: 1;
            background: var(--glass-panel-strong);
            color: var(--text-primary);
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            line-height: 1.2;
            white-space: nowrap;
            letter-spacing: 0.3px;
            font-weight: 500;
            box-shadow: 0 1px 3px var(--shadow-light);
            border: 1px solid var(--glass-border);
            transform: scale(calc(var(--inverse-scale, 1) * var(--label-hover-scale)));
            transform-origin: center center;
            opacity: 1;
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            will-change: transform;
        }

        .location-marker:hover .location-name {
            background: var(--text-primary);
            color: var(--bg-primary);
            --label-hover-scale: 1.05;
            opacity: 1;
        }

        .location-east { color: var(--primary-jade); }
        .location-west { color: var(--primary-red); }
        .location-south { color: var(--primary-orange); }
        .location-north { color: var(--primary-blue); }
        .location-center { color: var(--primary-purple); }
        .location-forbidden { color: #64748b; }
        .location-special { color: var(--primary-gold); }

        .hint-toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(80px);
            background: var(--toast-bg);
            color: var(--toast-text);
            padding: var(--spacing-s) var(--spacing-l);
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            z-index: 10000;
            pointer-events: none;
            opacity: 0;
            transition: all 0.3s var(--transition-smooth);
            letter-spacing: 0.5px;
            box-shadow: 0 4px 16px var(--shadow-strong);
            border: 1px solid var(--toast-border);
            text-shadow: var(--toast-text-shadow);
            backdrop-filter: blur(6px) saturate(120%);
            -webkit-backdrop-filter: blur(6px) saturate(120%);
        }

        .map-status-bar.expanded .map-canvas {
            animation: mapReveal 0.42s var(--transition-bounce);
        }

        .map-status-bar.expanded .location-marker {
            animation: markerReveal 0.45s var(--transition-bounce) both;
            animation-delay: var(--marker-delay, 0ms);
        }

        @keyframes mapReveal {
            0% {
                opacity: 0.52;
            }
            100% {
                opacity: 1;
            }
        }

        @keyframes markerReveal {
            0% {
                opacity: 0;
                transform: translateY(12px) scale(0.94);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes markerPulse {
            0% {
                transform: scale(0.85) rotate(-45deg);
                opacity: 0.45;
            }
            70% {
                transform: scale(1.45) rotate(-45deg);
                opacity: 0;
            }
            100% {
                opacity: 0;
            }
        }

        @keyframes spiritDrift {
            0%, 100% {
                transform: translate3d(0, 0, 0) scale(1);
                opacity: 0.07;
            }
            50% {
                transform: translate3d(0, -7px, 0) scale(1.05);
                opacity: 0.12;
            }
        }

        .hint-toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation: none !important;
                transition-duration: 0.01ms !important;
            }

            .map-status-bar.expanded .location-marker {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @media (max-width: 768px) {
            body {
                padding: var(--spacing-s);
            }

            .map-status-bar {
                border-radius: var(--spacing-m);
            }

            .map-header {
                padding: var(--spacing-s) var(--spacing-m);
            }

            .map-title {
                font-size: 14px;
            }

            .map-subtitle {
                display: none;
            }

            .map-status-bar.expanded .map-content {
                height: 380px;
            }

            .location-name {
                font-size: 10px;
                padding: 2px 4px;
            }

            .continent-label {
                font-size: 20px;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .map-status-bar.expanded .map-content {
                height: 420px;
            }
        }
    </style>
</head>

<body>
    <div class="map-status-bar collapsed" id="mapStatusBar">
        <div class="map-header" id="mapHeader">
            <div class="map-header-left">
                <svg class="map-icon" viewBox="0 0 24 24">
                    <path d="M12 2l-5.5 9h11z"/>
                    <circle cx="12" cy="17.5" r="4.5"/>
                </svg>
                <span class="map-title">苍玄大陆</span>
                <span class="map-subtitle">山河万里图</span>
            </div>
            <div class="map-controls">
                <div class="control-btn" id="themeToggle" onclick="event.stopPropagation()">
                    <svg viewBox="0 0 24 24">
                        <path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-3.03 0-5.5-2.47-5.5-5.5 0-1.82.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/>
                    </svg>
                </div>
                <div class="control-btn" id="resetView" onclick="event.stopPropagation()">
                    <svg viewBox="0 0 24 24">
                        <path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/>
                    </svg>
                </div>
            </div>
        </div>

        <div class="map-content" id="mapContent">
            <div class="map-viewport" id="mapViewport">
                <div class="map-canvas" id="mapCanvas">
                    <div class="continent-bg bg-east"></div>
                    <div class="continent-bg bg-west"></div>
                    <div class="continent-bg bg-south"></div>
                    <div class="continent-bg bg-north"></div>
                    <div class="continent-bg bg-center"></div>

                    <div class="continent-label label-east">东洲</div>
                    <div class="continent-label label-west">西洲</div>
                    <div class="continent-label label-south">南洲</div>
                    <div class="continent-label label-north">北洲</div>
                    <div class="continent-label label-center">中洲</div>

                    <div class="location-group">
                        <div class="location-marker location-east" style="left: 680px; top: 250px;" data-location="东洲-凌霄宗">
                            <div class="location-pin"></div>
                            <div class="location-name">凌霄宗</div>
                        </div>
                        <div class="location-marker location-east" style="left: 730px; top: 200px;" data-location="东洲-天剑宗">
                            <div class="location-pin"></div>
                            <div class="location-name">天剑宗</div>
                        </div>
                        <div class="location-marker location-east" style="left: 630px; top: 290px;" data-location="东洲-玄音阁">
                            <div class="location-pin"></div>
                            <div class="location-name">玄音阁</div>
                        </div>
                        <div class="location-marker location-east" style="left: 720px; top: 380px;" data-location="东洲-大晋皇朝">
                            <div class="location-pin"></div>
                            <div class="location-name">大晋皇朝</div>
                        </div>
                        <div class="location-marker location-east" style="left: 750px; top: 340px;" data-location="东洲-乾坤塔">
                            <div class="location-pin"></div>
                            <div class="location-name">乾坤塔</div>
                        </div>
                        <div class="location-marker location-east" style="left: 830px; top: 280px;" data-location="东洲-无尽海">
                            <div class="location-pin"></div>
                            <div class="location-name">无尽海</div>
                        </div>

                        <div class="location-marker location-west" style="left: 250px; top: 250px;" data-location="西洲-暗影宫">
                            <div class="location-pin"></div>
                            <div class="location-name">暗影宫</div>
                        </div>
                        <div class="location-marker location-west" style="left: 200px; top: 200px;" data-location="西洲-噬魂教">
                            <div class="location-pin"></div>
                            <div class="location-name">噬魂教</div>
                        </div>
                        <div class="location-marker location-west" style="left: 230px; top: 350px;" data-location="西洲-天欲宗">
                            <div class="location-pin"></div>
                            <div class="location-name">天欲宗</div>
                        </div>
                        <div class="location-marker location-west" style="left: 180px; top: 290px;" data-location="西洲-黑市">
                            <div class="location-pin"></div>
                            <div class="location-name">黑市</div>
                        </div>
                        <div class="location-marker location-west" style="left: 280px; top: 320px;" data-location="西洲-鬼市">
                            <div class="location-pin"></div>
                            <div class="location-name">鬼市</div>
                        </div>

                        <div class="location-marker location-south" style="left: 450px; top: 460px;" data-location="南洲-兽王山">
                            <div class="location-pin"></div>
                            <div class="location-name">兽王山</div>
                        </div>
                        <div class="location-marker location-south" style="left: 520px; top: 480px;" data-location="南洲-万妖岭">
                            <div class="location-pin"></div>
                            <div class="location-name">万妖岭</div>
                        </div>
                        <div class="location-marker location-south" style="left: 500px; top: 500px;" data-location="南洲-南楚国">
                            <div class="location-pin"></div>
                            <div class="location-name">南楚国</div>
                        </div>
                        <div class="location-marker location-south" style="left: 480px; top: 540px;" data-location="南洲-炎狱火山">
                            <div class="location-pin"></div>
                            <div class="location-name">炎狱火山</div>
                        </div>

                        <div class="location-marker location-north" style="left: 450px; top: 80px;" data-location="北洲-北燕王朝">
                            <div class="location-pin"></div>
                            <div class="location-name">北燕王朝</div>
                        </div>
                        <div class="location-marker location-north" style="left: 500px; top: 50px;" data-location="北洲-极北冰原">
                            <div class="location-pin"></div>
                            <div class="location-name">极北冰原</div>
                        </div>
                        <div class="location-marker location-north" style="left: 420px; top: 30px;" data-location="北洲-九幽地渊">
                            <div class="location-pin"></div>
                            <div class="location-name">九幽地渊</div>
                        </div>
                        <div class="location-marker location-north" style="left: 380px; top: 90px;" data-location="北洲-冰魄宫">
                            <div class="location-pin"></div>
                            <div class="location-name">冰魄宫</div>
                        </div>
                        <div class="location-marker location-north" style="left: 520px; top: 110px;" data-location="北洲-北海龙族">
                            <div class="location-pin"></div>
                            <div class="location-name">北海龙族</div>
                        </div>

                        <div class="location-marker location-center" style="left: 450px; top: 280px;" data-location="中洲-百花谷">
                            <div class="location-pin"></div>
                            <div class="location-name">百花谷</div>
                        </div>
                        <div class="location-marker location-center" style="left: 500px; top: 260px;" data-location="中洲-天机楼">
                            <div class="location-pin"></div>
                            <div class="location-name">天机楼</div>
                        </div>
                        <div class="location-marker location-center" style="left: 430px; top: 330px;" data-location="中洲-万宝阁">
                            <div class="location-pin"></div>
                            <div class="location-name">万宝阁</div>
                        </div>
                        <div class="location-marker location-center" style="left: 520px; top: 310px;" data-location="距离最近的斗法台">
                            <div class="location-pin"></div>
                            <div class="location-name">斗法台</div>
                        </div>
                        <div class="location-marker location-center" style="left: 380px; top: 270px;" data-location="中洲-上古药园">
                            <div class="location-pin"></div>
                            <div class="location-name">上古药园</div>
                        </div>
                        <div class="location-marker location-center" style="left: 520px; top: 140px;" data-location="中洲-荒古禁区">
                            <div class="location-pin"></div>
                            <div class="location-name">荒古禁区</div>
                        </div>

                        <div class="location-marker location-forbidden" style="left: 450px; top: 350px;" data-location="东西洲交界-葬仙谷">
                            <div class="location-pin"></div>
                            <div class="location-name">葬仙谷</div>
                        </div>

                        <div class="location-marker location-special" style="left: 550px; top: 180px;" data-location="虚空-太虚秘境">
                            <div class="location-pin"></div>
                            <div class="location-name">太虚秘境</div>
                        </div>

                        <div class="location-marker location-special" style="left: 600px; top: 350px;" data-location="距离最近的修真坊市">
                            <div class="location-pin"></div>
                            <div class="location-name">修真坊市</div>
                        </div>
                        <div class="location-marker location-special" style="left: 350px; top: 380px;" data-location="西洲-红尘楼">
                            <div class="location-pin"></div>
                            <div class="location-name">红尘楼</div>
                        </div>

                        <div class="location-marker location-special" style="left: 780px; top: 250px;" data-location="探寻距附近有没有元婴洞府">
                            <div class="location-pin"></div>
                            <div class="location-name">探寻元婴洞府</div>
                        </div>
                    </div>
                </div>

                <div class="zoom-controls">
                    <div class="zoom-btn" id="zoomIn">
                        <svg viewBox="0 0 24 24">
                            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                        </svg>
                    </div>
                    <div class="zoom-btn" id="zoomOut">
                        <svg viewBox="0 0 24 24">
                            <path d="M19 13H5v-2h14v2z"/>
                        </svg>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="hint-toast" id="hintToast"></div>

    <script>
        const mapStatusBar = document.getElementById('mapStatusBar');
        const mapHeader = document.getElementById('mapHeader');
        const mapContent = document.getElementById('mapContent');
        const themeToggle = document.getElementById('themeToggle');
        const resetView = document.getElementById('resetView');
        const mapCanvas = document.getElementById('mapCanvas');
        const mapViewport = document.getElementById('mapViewport');
        const hintToast = document.getElementById('hintToast');
        const locationMarkers = document.querySelectorAll('.location-marker');
        const zoomIn = document.getElementById('zoomIn');
        const zoomOut = document.getElementById('zoomOut');

        const UNIFIED_THEME_KEY = 'cangxuan_unified_theme';

        function applyTheme(theme) {
            const effectiveTheme = theme === 'light' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', effectiveTheme);
        }

        function toggleTheme() {
            const currentTheme = document.body.getAttribute('data-theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme(newTheme);
            localStorage.setItem(UNIFIED_THEME_KEY, newTheme);
        }

        function initTheme() {
            const savedTheme = localStorage.getItem(UNIFIED_THEME_KEY);
            applyTheme(savedTheme);
        }

        window.addEventListener('storage', (event) => {
            if (event.key === UNIFIED_THEME_KEY) {
                applyTheme(event.newValue);
            }
        });

        let isDragging = false;
        let startX, startY;
        let lastClickTime = 0;
        let toastTimeout;
        let currentTransform = { x: 0, y: 0, scale: 1 };
        let isExpanded = false;
        let pinchDistance = 0;
        let lastPinchDistance = 0;
        let animationFrameId = null;

        const MIN_SCALE = 0.5;
        const MAX_SCALE = 2.5;
        const SCALE_STEP = 0.2;
        const PINCH_SENSITIVITY = 0.008;

        function showToast(message) {
            clearTimeout(toastTimeout);
            hintToast.textContent = message;
            hintToast.classList.add('show');

            toastTimeout = setTimeout(() => {
                hintToast.classList.remove('show');
            }, 3000);
        }

        function toggleMap() {
            isExpanded = !isExpanded;
            if (isExpanded) {
                mapStatusBar.classList.add('expanded');
                mapStatusBar.classList.remove('collapsed');
                setTimeout(() => {
                    showToast('可放大缩小，地点可点击');
                }, 400);
            } else {
                mapStatusBar.classList.remove('expanded');
                mapStatusBar.classList.add('collapsed');
            }
        }

        function resetMapView() {
            currentTransform = { x: 0, y: 0, scale: 1 };
            updateTransform();
            showToast('视图已重置');
        }

        function updateTransform() {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            animationFrameId = requestAnimationFrame(() => {
                const pixelRatio = window.devicePixelRatio || 1;
                const snappedX = Math.round(currentTransform.x * pixelRatio) / pixelRatio;
                const snappedY = Math.round(currentTransform.y * pixelRatio) / pixelRatio;
                const snappedScale = Math.round(currentTransform.scale * 1000) / 1000;
                const inverseScale = Math.max(1 / MAX_SCALE, Math.min(1 / MIN_SCALE, 1 / snappedScale));

                mapCanvas.style.setProperty('--inverse-scale', inverseScale.toFixed(4));
                mapCanvas.style.transform = `translate3d(calc(-50% + ${snappedX}px), calc(-50% + ${snappedY}px), 0) scale(${snappedScale})`;
            });
        }

        function handleZoom(delta, centerX, centerY) {
            const oldScale = currentTransform.scale;
            const scaleDelta = delta > 0 ? SCALE_STEP : -SCALE_STEP;
            const newScale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, oldScale + scaleDelta));

            if (newScale !== oldScale) {
                const rect = mapViewport.getBoundingClientRect();
                const x = (centerX || rect.width / 2) - rect.left;
                const y = (centerY || rect.height / 2) - rect.top;

                const scaleRatio = newScale / oldScale;
                currentTransform.x = x - (x - currentTransform.x) * scaleRatio;
                currentTransform.y = y - (y - currentTransform.y) * scaleRatio;
                currentTransform.scale = newScale;

                updateTransform();
            }
        }

        function handleLocationClick(e) {
            lastClickTime = Date.now();
            e.stopPropagation();
            e.preventDefault();

            const marker = e.currentTarget;
            const location = marker.getAttribute('data-location');
            const inputText = `前往${location}`;

            try {
                const parentWindow = window.parent || window;
                const possibleSelectors = [
                    '#send_textarea',
                    '#user-input',
                    '#chat-input',
                    'textarea[name="user_input"]',
                    '.chat_input',
                    '#input_text',
                    'textarea',
                    'input[type="text"]'
                ];

                let inputElement = null;
                for (const selector of possibleSelectors) {
                    inputElement = parentWindow.document.querySelector(selector);
                    if (inputElement) break;
                }

                if (inputElement) {
                    inputElement.value = inputText;
                    inputElement.focus();

                    const inputEvent = new Event('input', { bubbles: true });
                    inputElement.dispatchEvent(inputEvent);

                    const changeEvent = new Event('change', { bubbles: true });
                    inputElement.dispatchEvent(changeEvent);

                    showToast(`已填入：${inputText}`);
                } else {
                    throw new Error('未找到输入框');
                }
            } catch (error) {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(inputText).then(() => {
                        showToast(`已复制：${inputText}`);
                    }).catch(() => {
                        showToast('操作失败，请手动输入');
                    });
                } else {
                    showToast('请手动输入地点');
                }
            }
        }

        mapHeader.addEventListener('click', toggleMap);
        themeToggle.addEventListener('click', toggleTheme);
        resetView.addEventListener('click', resetMapView);
        zoomIn.addEventListener('click', () => handleZoom(1));
        zoomOut.addEventListener('click', () => handleZoom(-1));

        mapViewport.addEventListener('wheel', (e) => {
            if (!isExpanded) return;
            e.preventDefault();
            handleZoom(e.deltaY > 0 ? -1 : 1, e.clientX, e.clientY);
        }, { passive: false });

        function handleDragStart(e) {
            if (!isExpanded) return;

            const currentTime = Date.now();
            if (currentTime - lastClickTime < 300) return;

            isDragging = true;
            mapCanvas.classList.add('dragging');

            if (e.type === 'mousedown') {
                startX = e.pageX - currentTransform.x;
                startY = e.pageY - currentTransform.y;
            } else if (e.touches.length === 1) {
                startX = e.touches[0].pageX - currentTransform.x;
                startY = e.touches[0].pageY - currentTransform.y;
            } else if (e.touches.length === 2) {
                isDragging = false;
                const dx = e.touches[0].pageX - e.touches[1].pageX;
                const dy = e.touches[0].pageY - e.touches[1].pageY;
                pinchDistance = Math.sqrt(dx * dx + dy * dy);
                lastPinchDistance = pinchDistance;
            }

            e.preventDefault();
        }

        function handleDragMove(e) {
            if (!isDragging) {
                if (e.touches && e.touches.length === 2) {
                    const dx = e.touches[0].pageX - e.touches[1].pageX;
                    const dy = e.touches[0].pageY - e.touches[1].pageY;
                    const newDistance = Math.sqrt(dx * dx + dy * dy);

                    if (lastPinchDistance > 0) {
                        const distanceDelta = newDistance - lastPinchDistance;
                        const scaleDelta = distanceDelta * PINCH_SENSITIVITY;

                        const oldScale = currentTransform.scale;
                        const newScale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, oldScale + scaleDelta));

                        if (Math.abs(newScale - oldScale) > 0.01) {
                            const centerX = (e.touches[0].pageX + e.touches[1].pageX) / 2;
                            const centerY = (e.touches[0].pageY + e.touches[1].pageY) / 2;

                            const rect = mapViewport.getBoundingClientRect();
                            const x = centerX - rect.left;
                            const y = centerY - rect.top;

                            const scaleRatio = newScale / oldScale;
                            currentTransform.x = x - (x - currentTransform.x) * scaleRatio;
                            currentTransform.y = y - (y - currentTransform.y) * scaleRatio;
                            currentTransform.scale = newScale;

                            updateTransform();
                        }
                    }

                    lastPinchDistance = newDistance;
                }
                return;
            }

            e.preventDefault();

            let x, y;
            if (e.type === 'mousemove') {
                x = e.pageX - startX;
                y = e.pageY - startY;
            } else if (e.touches.length === 1) {
                x = e.touches[0].pageX - startX;
                y = e.touches[0].pageY - startY;
            } else {
                return;
            }

            const viewportRect = mapViewport.getBoundingClientRect();
            const canvasWidth = 1000 * currentTransform.scale;
            const canvasHeight = 650 * currentTransform.scale;

            const maxX = Math.max(0, (canvasWidth - viewportRect.width) / 2);
            const maxY = Math.max(0, (canvasHeight - viewportRect.height) / 2);

            currentTransform.x = Math.max(-maxX, Math.min(maxX, x));
            currentTransform.y = Math.max(-maxY, Math.min(maxY, y));

            updateTransform();
        }

        function handleDragEnd() {
            if (isDragging) {
                isDragging = false;
                mapCanvas.classList.remove('dragging');
            }
            pinchDistance = 0;
            lastPinchDistance = 0;
        }

        mapCanvas.addEventListener('mousedown', handleDragStart);
        document.addEventListener('mousemove', handleDragMove);
        document.addEventListener('mouseup', handleDragEnd);

        mapCanvas.addEventListener('touchstart', handleDragStart, { passive: false });
        mapCanvas.addEventListener('touchmove', handleDragMove, { passive: false });
        mapCanvas.addEventListener('touchend', handleDragEnd, { passive: true });

        locationMarkers.forEach((marker, index) => {
            marker.style.setProperty('--marker-delay', `${Math.min(index * 26, 720)}ms`);
            marker.addEventListener('click', handleLocationClick);
            marker.addEventListener('touchend', handleLocationClick, { passive: false });
        });

        mapCanvas.addEventListener('click', (e) => {
            if (isDragging) {
                e.stopPropagation();
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && isExpanded) {
                toggleMap();
            }
        });

        initTheme();
        updateTransform();
        window.addEventListener('resize', updateTransform, { passive: true });
    </script>
</body>
</html>
